{% extends "base.html" %}
{% set title = "Admin - Inventory" %}

{% block content %}
<div class="page-header">
  <h1>Admin Inventory</h1>
  <p>Click a row to edit.</p>
</div>

<div class="content-card">
  <div class="search-bar" style="align-items:center;">
    <input id="q" class="search-input" placeholder="Quick search (SKU/material/location)..." />
    <a class="btn btn-success" href="/admin/add">+ Add New</a>
    <a class="btn btn-secondary" href="/api/export/csv">Export CSV</a>
  </div>
  <div class="search-divider"></div>
  <div class="search-filters" style="align-items:end;">
    <label class="filter-label">Filter Material Type<select class="filter_select" id="f_material" placeholder="Filter Material" style="width:100%; padding:8px;"></select></label>
    <label class="filter-label">Filter Grade<select class="filter_select" id="f_grade" placeholder="Filter Grade" style="width:100%; padding:8px;"></select></label>
    <label class="filter-label">Filter Location<select class="filter_select" id="f_location" style="width:100%; padding:8px;"></select></label>
    <div class="filter-buttons">  
      <button class="btn" id="searchBtn">Search</button>
      <button class="btn btn-secondary" id="clearBtn">Clear</button>
    </div>
  </div>
  <label style="display:flex; gap:8px; align-items:center; margin-left:3px; color:#4a5568;">
    <input type="checkbox" id="showZero">
    Show Out of Stock items
  </label>
</div>

<div class="content-card">
<div class="table-container">
  <table id="table">
    <thead>
      <tr>
        <th data-sort="sku" class="sortable">SKU</th>
        <th data-sort="material" class="sortable">Material</th>
        <th data-sort="grade" class="sortable">Grade</th>
        <th data-sort="description" class="sortable">Description</th>
        <th data-sort="length" class="sortable">Length</th>
        <th data-sort="location" class="sortable">Location</th>
        <th data-sort="quantity" class="sortable">Qty</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="mTitle">Item</h2>
      <button class="modal-close" id="mClose">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid" id="mBody"></div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script>

// Maps "ids" to labels for front end

async function loadLookupMap(fieldKey){
  const res = await fetch(`/api/lookups/${encodeURIComponent(fieldKey)}`);
  const items = await res.json().catch(()=> []);
  const map = {};
  for (const it of items) map[String(it.code)] = it.label;
  return map;
}

function labelOf(map, code){
  if (code === null || code === undefined) return "";
  const k = String(code);
  return map && map[k] ? map[k] : k;
}

// Dropdown field populators
populateLookupFilter("material", "f_material");
populateLookupFilter("grade", "f_grade");
populateLookupFilter("location", "f_location");
initSearchableSelects();

const modal = document.getElementById("modal");
document.getElementById("mClose").onclick = () => modal.classList.remove("active");
modal.addEventListener("click", (e) => { if (e.target === modal) modal.classList.remove("active"); });

function detail(label, value) {
  return `<div class="detail-item">
    <div class="detail-label">${label}</div>
    <div class="detail-value">${value ?? ""}</div>
  </div>`;
}



// state
let sortCol = "sku";
let sortDir = "asc";

function getFilters() {
  return {
    q: document.getElementById("q").value.trim(),
    include_zero: document.getElementById("showZero").checked ? "true" : "false",
    grade: document.getElementById("f_grade").value.trim(),
    material: document.getElementById("f_material").value.trim(),
    location: document.getElementById("f_location").value.trim(),
    sort: sortCol,
    dir: sortDir
  };
}

function toQuery(params) {
  const usp = new URLSearchParams();
  for (const [k,v] of Object.entries(params)) {
    if (v !== "" && v != null) usp.set(k, v);
  }
  return usp.toString();
}

async function load() {
  const qs = toQuery(getFilters());
  const url = qs ? `/api/inventory?${qs}` : "/api/inventory";
  const items = await (await fetch(url)).json();

  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML = "";

  for (const it of items) {
    const tr = document.createElement("tr");
    tr.className = "clickable";
    tr.innerHTML = `
      <td>${it.sku}</td>
      <td>${labelOf(materialMap, it.material)}</td>
      <td>${labelOf(gradeMap, it.grade)}</td>
      <td>${labelOf(descMap, it.description)}</td>
      <td>${it.length}</td>
      <td>${labelOf(locationMap, it.location)}</td>
      <td>${it.quantity ?? ""}</td>
      <td><a href="/admin/edit/${it.id}" class="btn btn-sm btn-edit" style="float:right;">Edit</a></td>`;
      const editLink = tr.querySelector(".btn-edit");
      if (editLink) editLink.addEventListener("click", (e) => e.stopPropagation());
    tr.onclick = () => {
      document.getElementById("mTitle").textContent = it.sku;
      document.getElementById("mBody").innerHTML =
        detail("Material", labelOf(materialMap, it.material)) +
        detail("Grade", labelOf(gradeMap, it.grade)) +
        detail("Description", labelOf(descMap, it.description)) +
        detail("Length", it.length) +
        detail("Location", labelOf(locationMap, it.location)) +
        detail("Quantity", it.quantity) +
        detail("Lbs/ft", it.lbs_per_ft) +
        detail("Weight", it.weight) +
        detail("Supplier", it.supplier) +
        detail("PO Number", it.po_number) +
        detail("Cost/lb", it.cost_lb) +
        detail("Notes", it.notes) +
        detail("Last updated on", it.updated_at) +
        `<div class="full-width-text" style="text-align:right; grid-column:1 / -1; height:45px;"><a href="/admin/edit/${it.id}" class="btn btn-edit" style="margin-top:15px; max-width:104px;">Edit Item</a></div>`;
      modal.classList.add("active");
    };
    tbody.appendChild(tr);
  }
}


// Sorting
document.querySelectorAll("th.sortable").forEach(th => {
  th.style.cursor = "pointer";
  th.onclick = () => {
    const col = th.getAttribute("data-sort");
    if (sortCol === col) sortDir = (sortDir === "asc" ? "desc" : "asc");
    else { sortCol = col; sortDir = "asc"; }
    load();
  };
});

// Global controls
document.getElementById("searchBtn").onclick = () => load();
document.getElementById("clearBtn").onclick = () => {
  document.getElementById("q").value = "";
  document.getElementById("f_grade").value = "";
  document.getElementById("f_material").value = "";
  document.getElementById("f_location").value = "";
  document.getElementById("showZero").checked = false;
  sortCol = "sku"; sortDir = "asc";
  load();
};
document.getElementById("showZero").onchange = () => load();

// Per-column filter live reload (debounced)
let t = null;
function debounceLoad() {
  clearTimeout(t);
  t = setTimeout(load, 250);
}
["f_grade","f_material","q"].forEach(id => {
  document.getElementById("f_grade").addEventListener("change", load);
  document.getElementById("f_material").addEventListener("change", load);
  document.getElementById("f_location").addEventListener("change", load);
  document.getElementById(id).addEventListener("input", debounceLoad);
});


// Calls Maps

let materialMap = {}, gradeMap = {}, descMap = {}, locationMap = {}, unitMap = {};

async function initMaps(){
  materialMap = await loadLookupMap("material");
  gradeMap = await loadLookupMap("grade");
  descMap = await loadLookupMap("description");
  locationMap = await loadLookupMap("location");
  unitMap = await loadLookupMap("unit"); // only if unit is a lookup; remove if not
}

initMaps().then(load);

</script>

{% endblock %}
