{% extends "base.html" %}
{% set title = "Shop - New SKU" %}

{% block content %}
<div class="page-header">
  <h1>New SKU</h1>
  <p>Submit a request to create a new SKU.</p>
</div>

<div class="content-card">
  <div id="msg"></div>

  <div class="form-grid">
    <div class="form-group"><label>SKU (next available)</label><input id="sku" readonly></div>
    <div class="form-group"><label>Material</label><select class="searchable" id="material"></select></div>
    <div class="form-group"><label>Grade</label><select class="searchable" id="grade"></select></div>
    <div class="form-group"><label>Description</label><select class="searchable" id="description"></select></div>
    <div class="form-group"><label>Length (ft)</label><input id="length" type="number" step="0.5"></div>
    <div class="form-group"><label>Location</label><select class="searchable" id="location"></select></div>
    <div class="form-group"><label>Quantity</label><input id="quantity" type="number" step="0.01" value="1"></div>
    <div class="form-group"><label>Notes</label><textarea id="notes"></textarea></div>
  </div>

  <button class="btn" id="submit">Submit New Item</button>
</div>
{% endblock %}

{% block scripts %}
<script>
function show(type, text){ document.getElementById("msg").innerHTML = `<div class="message message-${type}">${text}</div>`; }

async function generateSKU(){
  const data = await (await fetch("/api/next-sku")).json();
  document.getElementById("sku").value = data.sku || "";
}

generateSKU();

// Dropdown field populator
populateLookupSelect("location", "location");
populateLookupSelect("description", "description");
populateLookupSelect("grade", "grade");
populateLookupSelect("material", "material");
initSearchableSelects();

document.getElementById("submit").onclick = async () => {
  const payload = {
    request_type: "new",
    sku: document.getElementById("sku").value.trim(),
    material: document.getElementById("material").value.trim(),
    length: document.getElementById("length").value,
    location: document.getElementById("location").value.trim(),
    quantity: document.getElementById("quantity").value,
    notes: document.getElementById("notes").value.trim()
  };

  const res = await fetch("/api/requests/submit", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  const data = await res.json().catch(()=> ({}));
  if (res.ok && data.success) {
    show("success","New SKU request submitted.");
    // Optional: clear fields and generate the next SKU
    document.getElementById("material").value = "";
    document.getElementById("length").value = "";
    document.getElementById("location").value = "";
    document.getElementById("quantity").value = "1";
    document.getElementById("notes").value = "";
    generateSKU();
  } else {
    show("error", data.error || "Failed to submit request");
  }
};
</script>
{% endblock %}
