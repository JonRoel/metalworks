{% extends "base.html" %}
{% set title = "Admin - Pending Requests" %}

{% block content %}
<div class="page-header">
  <h1>Pending Requests</h1>
  <p>Approve or decline shop requests.</p>
</div>

<div class="content-card">
  <div id="msg"></div>
  <div id="list"></div>
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Request</h2>
        <button class="modal-close" id="editClose">×</button>
      </div>
      <div class="modal-body">
        <div id="editInfo" style="margin-bottom:12px;"></div>
        <div id="editSkuRow" class="detail-item" style="margin-bottom:15px;">
          <div class="detail-label">SKU</div>
          <div class="detail-value" id="e_sku_display"></div>
        </div>

        <div class="form-grid">
          <div class="form-group"><label>Material</label><select class="searchable" id="e_material"></select></div>
          <div class="form-group"><label>Grade</label><select class="searchable" id="e_grade"></select></div>
          <div class="form-group"><label>Description</label><select class="searchable" id="e_description"></select></div>
          <div class="form-group"><label>Length</label><input id="e_length" type="number" step="0.5"></div>
          <div class="form-group"><label>Unit</label><input id="e_unit"></div>
          <div class="form-group"><label>Location</label><select class="searchable" id="e_location"></select></div>
          <div class="form-group"><label>Quantity</label><input id="e_quantity" type="number" step="1"></div>
          <div class="form-group"><label>Lbs/ft</label><input id="e_lbs_per_ft" type="number" step="0.01"></div>
          <div class="form-group"><label>Weight</label><input id="e_weight" type="number" step="0.01"></div>
          <div class="form-group"><label>Supplier</label><input id="e_supplier"></div>
          <div class="form-group"><label>PO Number</label><input id="e_po_number"></div>
          <div class="form-group"><label>Cost/lb</label><input id="e_cost_lb" type="number" step="0.01"></div>
          <div class="form-group" style="grid-column: 1 / -1;"><label>Notes</label><textarea id="e_notes"></textarea></div>
        </div>
      </div>
      <div class="modal-footer" style="padding:0 30px 30px 15px; text-align: right;">
        <button class="btn btn-secondary" id="editCancel">Cancel</button>
        <button class="btn btn-success" id="editApprove">Approve (with edits)</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentEditId = null;
let currentEditType = null;
let currentEditSku = null;

// Mapping for displayed items to show labels only

async function loadLookupMap(fieldKey){
  const res = await fetch(`/api/lookups/${encodeURIComponent(fieldKey)}`);
  const items = await res.json().catch(()=> []);
  const map = {};
  for (const it of items) map[String(it.code)] = it.label;
  return map;
}

function labelOf(map, code){
  if (code === null || code === undefined) return "";
  const k = String(code);
  return map && map[k] ? map[k] : k;
}

const editModal = document.getElementById("editModal");
const closeEdit = () => editModal.classList.remove("active");

async function initLookups() {
  await Promise.all([
    populateLookupSelect("location", "e_location", ""),
    populateLookupSelect("description", "e_description", ""),
    populateLookupSelect("grade", "e_grade", ""),
    populateLookupSelect("material", "e_material", ""),
  ]);
  initSearchableSelects(document);
}

initLookups().catch(err => {
  console.error("Lookup init failed:", err);
  show("error", "Failed to load dropdowns.");
});

document.getElementById("editClose").onclick = closeEdit;
document.getElementById("editCancel").onclick = closeEdit;
editModal.addEventListener("click", (e) => { if (e.target === editModal) closeEdit(); });
// map fields to edit fields
function setEditFields(d) {
  document.getElementById("e_material").value = d.material ?? "";
  document.getElementById("e_grade").value = d.grade ?? "";
  document.getElementById("e_description").value = d.description ?? "";
  document.getElementById("e_length").value = d.length ?? "";
  document.getElementById("e_unit").value = d.unit ?? "";
  document.getElementById("e_location").value = d.location ?? "";
  document.getElementById("e_quantity").value = d.quantity ?? "";
  document.getElementById("e_lbs_per_ft").value = d.lbs_per_ft ?? "";
  document.getElementById("e_weight").value = d.weight ?? "";
  document.getElementById("e_supplier").value = d.supplier ?? "";
  document.getElementById("e_po_number").value = d.po_number ?? "";
  document.getElementById("e_cost_lb").value = d.cost_lb ?? "";
  document.getElementById("e_notes").value = d.notes ?? "";
}

function show(type, text){ document.getElementById("msg").innerHTML = `<div class="message message-${type}">${text}</div>`; }

function safeParse(s){
  try { return s ? JSON.parse(s) : null; } catch(e){ return null; }
}
function changedRows(oldD, newD){
  const fields = ["material", "grade", "description", "length", "unit", "location","quantity", "lbs_per_ft", "weight","supplier","po_number", "cost_lb","notes"];
  let html = `<table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr><th>Field</th>
        <th>Current</th>
        <th>Change to</th></tr>
      </thead>
    <tbody>`;
  for (const f of fields){
    const o = oldD ? oldD[f] : "";
    const n = newD ? newD[f] : "";
    const different = String(o ?? "") !== String(n ?? "");
    if (different){
      html += `<tr>
        <td><b>${f}</b></td>
        <td>${o ?? ""}</td>
        <td>${n ?? ""}</td>
      </tr>`;
    }
  }
  html += `</tbody></table>`;
  return html;
}

function card(r) {
  const oldD = safeParse(r.old_data);
  const newD = safeParse(r.new_data);

  const compare = (r.request_type === "adjust")
    ? changedRows(oldD, newD)
    : `<div class="detail-grid">
        <div class="detail-item"><div class="detail-label">SKU</div><div class="detail-value">${r.sku}</div></div>
        <div class="detail-item"><div class="detail-label">Material</div><div class="detail-value">${labelOf(materialMap, r.material)}</div></div>
        <div class="detail-item"><div class="detail-label">Grade</div><div class="detail-value">${labelOf(gradeMap, r.grade)}</div></div>
        <div class="detail-item"><div class="detail-label">Description</div><div class="detail-value">${labelOf(descMap, r.description)}</div></div>
        <div class="detail-item"><div class="detail-label">Length</div><div class="detail-value">${r.length}</div></div>
        <div class="detail-item"><div class="detail-label">Location</div><div class="detail-value">${labelOf(locationMap, r.location)}</div></div>
        <div class="detail-item"><div class="detail-label">Quantity</div><div class="detail-value">${r.quantity}</div></div>
      </div>`;

  return `
  <div class="request-card">
    <div class="request-header">
      <div><b>${r.request_type.toUpperCase()}</b> ${r.sku ? " - " + r.sku : ""}</div>
    </div>

    <div style="margin-bottom:12px;">${compare}</div>

    <div class="request-actions">
      <button class="btn btn-success" data-approve="${r.id}">Approve</button>
      <button class="btn btn-secondary" data-edit="${r.id}">Edit</button>
      <button class="btn btn-danger" data-decline="${r.id}">Decline</button>
    </div>

  </div>`;
}

async function load() {
  const res = await fetch("/api/requests/pending");
  const data = await res.json();
  const list = document.getElementById("list");

  if (!data.length) { list.innerHTML = `<div class="empty-state">No pending requests.</div>`; return; }
  list.innerHTML = data.map(card).join("");

  document.querySelectorAll("[data-approve]").forEach(btn => btn.onclick = async () => {
  const id = btn.getAttribute("data-approve");

  const r = await fetch(`/api/requests/${id}/approve`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({})   // ✅ important
  });

  if (r.ok) {
    show("success","Approved.");
    load();
  } else {
    const d = await r.json().catch(()=> ({}));
    show("error", d.error || "Approve failed");
  }
});

  document.querySelectorAll("[data-decline]").forEach(btn => btn.onclick = async () => {
    const id = btn.getAttribute("data-decline");
    const r = await fetch(`/api/requests/${id}/decline`, {method:"POST"});
    if (r.ok) { show("success","Declined."); load(); } else show("error","Decline failed");
  });

  // Pulls in data into modal

  document.querySelectorAll("[data-edit]").forEach(btn => btn.onclick = async () => {
    const id = btn.getAttribute("data-edit");
    currentEditId = id;

    const req = data.find(x => String(x.id) === String(id));
    currentEditType = req.request_type;
    currentEditSku = req.sku;

    document.getElementById("e_sku_display").textContent = req.sku || "";
    document.getElementById("editSkuRow").style.display = req.sku ? "block" : "none";

    const newD = safeParse(req.new_data) || req;
    const oldD = safeParse(req.old_data) || {};
    const merged = { ...oldD, ...newD };

    document.getElementById("editInfo").innerHTML =
      `<div class="message message-info">Editing request <b>#${id}</b> ${req.sku ? "for SKU <b>" + req.sku + "</b>" : ""}</div>`;

    // Populate ALL lookup selects with the stored CODE values
    await populateLookupSelect("material", "e_material", merged.material || "");
    await populateLookupSelect("grade", "e_grade", merged.grade || "");
    await populateLookupSelect("description", "e_description", merged.description || "");
    await populateLookupSelect("location", "e_location", merged.location || "");

    // Re-init searchable UI inside modal AFTER options exist
    initSearchableSelects(document.getElementById("editModal"));

    // Set non-select fields
    document.getElementById("e_length").value = merged.length ?? "";
    document.getElementById("e_unit").value = merged.unit ?? "";
    document.getElementById("e_quantity").value = merged.quantity ?? "";
    document.getElementById("e_lbs_per_ft").value = merged.lbs_per_ft ?? "";
    document.getElementById("e_weight").value = merged.weight ?? "";
    document.getElementById("e_supplier").value = merged.supplier ?? "";
    document.getElementById("e_po_number").value = merged.po_number ?? "";
    document.getElementById("e_cost_lb").value = merged.cost_lb ?? "";
    document.getElementById("e_notes").value = merged.notes ?? "";

    editModal.classList.add("active");
  });
}

  document.getElementById("editApprove").onclick = async () => {
    
    if (!currentEditId) return;

    // For adjust: send only fields admin *actually changed*? simplest v1: send all non-empty
    const overrides = {
      material: document.getElementById("e_material").value,
      grade: document.getElementById("e_grade").value,
      description: document.getElementById("e_description").value,
      length: document.getElementById("e_length").value,
      unit: document.getElementById("e_unit").value.trim(),
      location: document.getElementById("e_location").value,
      quantity: document.getElementById("e_quantity").value,
      lbs_per_ft: document.getElementById("e_lbs_per_ft").value,
      weight: document.getElementById("e_weight").value,
      supplier: document.getElementById("e_supplier").value.trim(),
      po_number: document.getElementById("e_po_number").value.trim(),
      cost_lb: document.getElementById("e_cost_lb").value,
      notes: document.getElementById("e_notes").value.trim(),
  };

  // Clean empties so backend treats them as "not provided"
  for (const k of Object.keys(overrides)) {
    if (overrides[k] === "" || overrides[k] === null) delete overrides[k];
  }

  const res = await fetch(`/api/requests/${currentEditId}/approve`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(overrides)
  });


  if (res.ok) {
  show("success", "Approved with edits.");
  closeEdit();
  load();
} else {
  const d = await res.json().catch(()=> ({}));
  show("error", d.error || "Approve failed.");
}

};

// Function to deploy maps

let materialMap = {}, gradeMap = {}, descMap = {}, locationMap = {}, unitMap = {};

async function initMaps(){
  materialMap = await loadLookupMap("material");
  gradeMap = await loadLookupMap("grade");
  descMap = await loadLookupMap("description");
  locationMap = await loadLookupMap("location");
  unitMap = await loadLookupMap("unit"); // only if unit is a lookup; remove if not
}

initMaps().then(load);
</script>
{% endblock %}
